<% provide(:title,"#{@provider.name} - profile") %>

<div class="container hax-body-styling">
  <div class="row">
     <div class="col-md-4">
      <p><%= link_to "Back to Suppliers List", teams_index_path %></p>
    </div>
  </div>
  <div class="row">
    <!-- BEGIN LEFT COLUMN -->
    <div class="col-md-4">
      
      <!-- COMPANY NAME -->
      <div class="profile-spacing">
        <h1>
        <%= @provider.name %>
        <span class="heading_navigation">[<%= link_to "Edit", edit_provider_with_event_path(@provider.id,"edit_providername_from_profile") %>]</span>
        </h1>
      </div>
      
      <!-- STAR RATINGS -->
      <!-- need to add an if statement to handle the case when there are no comments (and prompt the user to add a comment) -->
      <div class="row">
        <%= render partial: "providers/star_display", locals: {score: @provider.average_score} %>
        <span class="heading_navigation">
          <a href="#comments">
            <% total_provider_comments = @provider.comments.count %>
            <% if total_provider_comments %>
              <%= "#{pluralize(total_provider_comments, 'comment')}" %>
            <% end %>
          </a>
        </span>
      </div>      

      <!-- PURCHASE ORDERS -->
      <h3 class="profile-heading">
        Purchase orders
       <span class="heading_navigation">[<%= link_to "add a purchase", new_purchase_order_comment_path(@provider.id) %>]</span>
       </h3>  
       <ul>
        <% @po_names.each do |name| %>
          <li><%= "#{name}" %></li>
        <% end %>
      </ul>
      </div> 

      <!-- BEGIN MIDDLE COLUMN -->
      <div class="col-md-4">
        <!-- CATEGORIES -->
        <h3 class="profile-heading">
          What they can do for you
         <span class="heading_navigation">[<%= link_to "Edit", edit_provider_with_event_path(@provider.id, "edit_whatcantheydo_from_profile") %>]</span>
        </h3>
        <div class="tags-providerTags">
          <% @tags.each do |tag| %>
            <a><%= "#{tag.readable}" %></a>
        <% end %>
        </div>
      </div>        

      <!-- BEGIN RIGHT COLUMN -->
      <div class="col-md-4">
        <div class="table-header">
        <!-- ADDRESS SECTION -->
          <h3 class="profile-heading">Contact information <span class="heading_navigation">[<%= link_to "Edit", edit_provider_with_event_path(@provider.id, "edit_contactinfo_from_profile") %>]</span></h3>
          <ul>
            <li><strong>Best person to contact: </strong> <%= "#{@provider.contact_name} (role: #{@provider.contact_role})"%></li>
            <li><strong>Phone: </strong><%= @provider.contact_phone %></li>
            <li><strong>Email: </strong><%= @provider.contact_email %></li>
            <li><strong>Website: </strong><%= link_to "Link", @provider.url_main if @provider.url_main %></li            
            <li><strong>Full address: </strong><%= "#{@provider.address}" %></li>
          </ul>    
        </div>
      </div>
    </div>

  <div class="row col-md-12">
    <hr>
    <h3 class="profile-heading">Company Synopsis</h3>
    <p><%= raw(@provider.external_notes) %></p>
  </div>

  <div class="row col-md-12">
    <h3 class="profile-heading"><%= @organization.name %> internal notes</h3>
    <p><%= raw(@provider.organization_private_notes) %></p>
  </div>

  <div class="row">
    <div class="col-md-8">
      <h3 id="comments" class="profile-heading">
        Comments
        <span class="heading_navigation">[<%= link_to "add a comment", new_comment_path(@provider.id) %>]</span>
      </h3>

      <% if @comments.present? %>
        <% @comments.each do |comment| %>
          <hr>
          <div class="row">
          <div class="col-md-3">
            <div class="row">
              <img class="avatar-profile"/>
            </div>
            <div class="row comment-profile">
              <% contact = comment.user.lead.lead_contact %>
              <p><strong><%= "#{contact.first_name} " %></strong></p>
              <p class="comment-smalltext"><%= "Team: #{contact.contactable.user.team.name}" if contact.contactable.user.team.present? %></p>
              <% total_comments = @total_comments_for_user[comment.user.id] %>
              <% if total_comments %>
                <p class="comment-smalltext"><%= "#{pluralize(total_comments, 'comment')}" %></p>
              <% end %>
              <% purchase_order_comments = @purchase_order_comments_for_user[comment.user.id] %>
              <% if purchase_order_comments %>
                <p class="comment-smalltext"><%= "#{pluralize(purchase_order_comments, 'purchase order')}" %></p>
              <% end %>
            </div>
          </div>

          <div class="col-md-9 comment">

            <div class="row">
              <span class="comment-smalltext"> 
                <% if comment.ratings_count.present? && comment.ratings_count > 0 %>
                  <%= "#{comment.helpful_count} of #{comment.ratings_count} users found this comment helpful" %>
                <% end %>
              </span>
            </div>

            <div class="row">
              <% if comment.title.present? %>
                <h3 class="comment-snippet">
                  <%= comment.title %>
                </h3>
              <% end %>
            </div>

            <div class="row">
              <% if comment.overall_score > 0 %>
                <%= render partial: "providers/star_display", locals: {score: comment.overall_score} %>
              <% end %>
              <span class="comment-smalltext"> 
                <%= "Reviewed #{comment.created_at.strftime('%Y-%m-%d')}" %>
              </span>
            </div>

            <div class="row">
              <p><%= raw(comment.payload) %></p>
            </div>

            <div class="row comment-smalltext">
              <% po = comment.purchase_order %>
              <% if po %>
              <div>About this order:</div>
                <div class="col-md-8">
                  <% po.tags.each do |tag| %>
                    <div class="col-md-3"><%= tag.tag_group.group_name %>: </div>
                    <div class="col-md-9"><%= tag.readable %></div>
                  <% end %>
                </div>
                <div class="col-md-4">
                  <div><%= "Quantity: #{po.quantity}" if po.quantity %></div>
                  <div><%= "Price: $#{po.price}" if po.price %></div>
                </div>
              <% end %>
            </div>

            <div>
              <% rating = comment.rating_by current_user %>
              <% if rating.nil? %>
                <%= form_tag comment_ratings_path do %>
                <span class="comment-smalltext"> 
                  Was this comment helpful to you?
                </span>
                  <%= hidden_field_tag :provider_id, @provider.id %>
                  <%= hidden_field_tag :comment_id, comment.id %>
                  <%= submit_tag "Yes" %>
                  <%= submit_tag "No" %>
                <% end %>
              <% elsif rating.helpful %>
              <span class="comment-smalltext"> 
                <em>You found this comment helpful</em>
              </span>
              <% else %>
              <span class="comment-smalltext"> 
                <em>You didn't find this comment helpful. <a href="mailto:suggest-edits@supplybetter.com">Give feedback</a></em>
              </span>
              <% end %>
            </div>

          </div>
         </div>
        <% end %>
      <% else %>
          <p>No information yet - <%= link_to "add the first comment", new_comment_path(@provider.id) %>!</p>
      <% end %>
      </div>
    </div>

  </div>
</div>

<!-- PHOTO GALLERY -->
<script>
$(document).ready(function(){        
    $('li img').on('click',function(){
        var src = $(this).attr('src');
        var img = '<img src="' + src + '" class="img-responsive"/>';
        
        //start of new code new code
        var index = $(this).parent('li').index();   
        
        var html = '';
        html += img;                
        html += '<div style="height:25px;clear:both;display:block;">';
        html += '<a class="controls next" href="'+ (index+2) + '">next &raquo;</a>';
        html += '<a class="controls previous" href="' + (index) + '">&laquo; prev</a>';
        html += '</div>';
        
        $('#myModal').modal();
        $('#myModal').on('shown.bs.modal', function(){
            $('#myModal .modal-body').html(html);
            //new code
            $('a.controls').trigger('click');
        })
        $('#myModal').on('hidden.bs.modal', function(){
            $('#myModal .modal-body').html('');
        });    
   });

})

//new code
$(document).on('click', 'a.controls', function(){
    var index = $(this).attr('href');
    var src = $('ul.row li:nth-child('+ index +') img').attr('src');             
    
    $('.modal-body img').attr('src', src);
    
    var newPrevIndex = parseInt(index) - 1; 
    var newNextIndex = parseInt(newPrevIndex) + 2; 
    
    if($(this).hasClass('previous')){               
        $(this).attr('href', newPrevIndex); 
        $('a.next').attr('href', newNextIndex);
    }else{
        $(this).attr('href', newNextIndex); 
        $('a.previous').attr('href', newPrevIndex);
    }
    
    var total = $('ul.row li').length + 1; 
    //hide next button
    if(total === newNextIndex){
        $('a.next').hide();
    }else{
        $('a.next').show()
    }            
    //hide previous button
    if(newPrevIndex === 0){
        $('a.previous').hide();
    }else{
        $('a.previous').show()
    }
    
    
    return false;
});                         
</script>
