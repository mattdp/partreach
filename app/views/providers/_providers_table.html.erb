<div class="stylish provider-table">
  <table>
    <thead>
      <tr>
        <th>Company Name</th>
        <th>Location</th>
        <th>Reviews</th>
        <th>POs</th>
        <th>Latest PO</th>
        <% if include_tag_column %>
          <th>Tags</th>
        <% end %>
      </tr>
    </thead>

    <%#= not organization specific cache busting %>
    <% cache_if(cache_result, "#{current_organization.id}-providers_table-#{Provider.maximum(:updated_at)}") do %>
      <tbody>        
        <% providers.each do |provider| %>
          <%#= imperfect, but rerun provider when it was updated or any po has been updated. probably means we should hit this table after an upload run. not currently worried about needing exact right tags on a fast timeline. also, this currently cuts across orgs, may want to scope the Provider updated at some point. %>
          <% cache_if(cache_result,provider) do %>
            <tr>
              <% comments = provider.comments %>
              <td><%= link_to "#{provider.name}", teams_profile_path(provider.name_for_link) %></td>
              <td><%= "#{provider.index_address}" %></td>
              <td>
                <div class="row">
                  <%= render partial: "providers/star_display", locals: {score: provider.average_score, include_hidden_number: true} %>
                </div>
              </td>
              <td>
                <%= link_to "#{provider.purchase_orders.count == 0 ? '' : provider.purchase_orders.count}", teams_profile_path(provider.name_for_link, :anchor => 'comments') %>
              </td>
              <td><%= link_to "#{provider.latest_purchase_order_date(true)}", teams_profile_path(provider.name_for_link, :anchor => 'comments') %></td>
              <% if include_tag_column %>
                <td>                            
                  <%= render partial: "providers/tag_display", locals: {tags: provider.tags, remove_bottom_margin: false, max_tags_to_display: 4} %>
                </td>
              <% end %>
            </tr>
          <% end %>             
        <% end %>  
      </tbody>
    <% end %>
    <tr>
      <td><%= link_to "[Add to this list]" , new_provider_with_event_path("add_provider_from_index")%></td>
    </tr>  
  </table>
</div>


<!-- This is not DRY, but it works for now -->
<% if include_tag_column %>
  <script>
    var $table = $('table'),
        process = false;

    $('.process').click(function(){
      process = !process;
      $.tablesorter.isProcessing( $table, process );
    });

    $('.sortable').click(function(){
      $table
        .find('.tablesorter-header:last').toggleClass('sorter-false')
        .trigger('update');
    });

    $table.tablesorter({
      theme: 'bootstrap',
      headerTemplate: '{content} {icon}',
      sortList: [ [2,1], [0,0] ],
      widgets : ['columns', 'uitheme', 'filter'] // add 'filter' to get the search row back
    });
  </script>
<% else %>
  <script>
    var $table = $('table'),
        process = false;

    $('.process').click(function(){
      process = !process;
      $.tablesorter.isProcessing( $table, process );
    });

    $('.sortable').click(function(){
      $table
        .find('.tablesorter-header:last').toggleClass('sorter-false')
        .trigger('update');
    });

    $table.tablesorter({
      theme: 'bootstrap',
      headerTemplate: '{content} {icon}',
      sortList: [ [2,1], [0,0] ],
      widgets : ['columns', 'uitheme'] // add 'filter' to get the search row back
    });
  </script>
<% end %>
