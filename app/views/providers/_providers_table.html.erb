<div class="stylish provider-table">
  <table>
    <thead>
      <tr>
        <th>Company Name</th>
        <th>Location</th>
        <th>Reviews</th>
        <th>POs</th>
        <th>Latest PO</th>
        <% if include_tag_column %>
          <th>Tags</th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% row_count = 1 %>
      <% pos_updated = PurchaseOrder.maximum(:updated_at) %>
      <% providers.each do |provider| %>
        <%#= imperfect, but rerun provider when it was updated or any po has been updated. probably means we should hit this table after an upload run. not currently worried about needing exact right tags on a fast timeline. also, this currently cuts across orgs, may want to scope the pos_updated at some point. %>
        <% cache("#{provider.id}-#{provider.updated_at}-#{pos_updated}") do %>
          <tr>
            <% comments = provider.comments %>
            <td><%= link_to "#{provider.name}", teams_profile_path(provider.name_for_link) %></td>
            <td><%= "#{provider.index_address}" %></td>
            <td>
              <div class="row">
                <%= render partial: "providers/star_display", locals: {score: provider.average_score, include_hidden_number: true} %>
              </div>
            </td>
            <td>
              <%= link_to "#{provider.purchase_orders.count == 0 ? '' : provider.purchase_orders.count}", teams_profile_path(provider.name_for_link, :anchor => 'comments') %>
            </td>
            <td><%= link_to "#{provider.latest_purchase_order_date(true)}", teams_profile_path(provider.name_for_link, :anchor => 'comments') %></td>
            <% if include_tag_column %>
              <td>                            
                <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                  <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="headingOne">
                      <div class="panel-title">
                        <a role="button" data-toggle="collapse" data-parent="#accordion" href="<%= "##{row_count}" %>" aria-expanded="true" aria-controls="<%= "#{row_count}" %>">
                          (click to see tags)
                        </a>
                      </div>
                    </div>
                    <div id="<%= "#{row_count}" %>" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
                      <div class="panel-body">
                        <%= render partial: "providers/tag_display", locals: {tags: provider.tags, remove_bottom_margin: false, max_tags_to_display: nil} %>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            <% end %>
          </tr>
          <% row_count += 1 %>
        <% end %>             
      <% end %>  
    </tbody>
    <tr>
      <td><%= link_to "[Add to this list]" , new_provider_with_event_path("add_provider_from_index")%></td>
    </tr>  
  </table>
</div>


<!-- This is not DRY, but it works for now -->
<% if include_tag_column %>
  <script>
    var $table = $('table'),
        process = false;

    $('.process').click(function(){
      process = !process;
      $.tablesorter.isProcessing( $table, process );
    });

    $('.sortable').click(function(){
      $table
        .find('.tablesorter-header:last').toggleClass('sorter-false')
        .trigger('update');
    });

    $table.tablesorter({
      theme: 'bootstrap',
      headerTemplate: '{content} {icon}',
      sortList: [ [2,1], [0,0] ],
      widgets : ['columns', 'uitheme', 'filter'] // add 'filter' to get the search row back
    });
  </script>
<% else %>
  <script>
    var $table = $('table'),
        process = false;

    $('.process').click(function(){
      process = !process;
      $.tablesorter.isProcessing( $table, process );
    });

    $('.sortable').click(function(){
      $table
        .find('.tablesorter-header:last').toggleClass('sorter-false')
        .trigger('update');
    });

    $table.tablesorter({
      theme: 'bootstrap',
      headerTemplate: '{content} {icon}',
      sortList: [ [2,1], [0,0] ],
      widgets : ['columns', 'uitheme'] // add 'filter' to get the search row back
    });
  </script>
<% end %>
